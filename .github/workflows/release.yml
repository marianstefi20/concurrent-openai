name: Release

on:
    push:
        branches:
            - main

jobs:
    release:
        runs-on: ubuntu-latest
        concurrency:
            group: ${{ github.workflow }}-${{ github.ref }}
            cancel-in-progress: true
        
        permissions:
            contents: write
            id-token: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                fetch-depth: 0
            
            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                python-version: '3.11'

            - name: Install Poetry
              uses: snok/install-poetry@v1
            
            - name: Install dependencies
              run: |
                poetry install
            
            - name: Release
              id: release
              uses: python-semantic-release/python-semantic-release@v9.15.2
              with:
                github_token: ${{ secrets.GH_TOKEN }}
                
            - name: Publish to PyPI
              uses: pypa/gh-action-pypi-publish@v1.12.3
              if: steps.release.outputs.released == 'true'
              with:
                password: ${{ secrets.PYPI_API_TOKEN }}
                          
            - name: Python Semantic Release - Publish
              uses: python-semantic-release/publish-action@v9.15.2
              if: steps.release.outputs.released == 'true'
              with:
                github_token: ${{ secrets.GH_TOKEN }}
